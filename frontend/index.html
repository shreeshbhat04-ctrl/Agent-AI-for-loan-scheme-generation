<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanBot Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-bubble { max-width: 75%; }
        .chat-bubble-user { background-color: #3B82F6; color: white; }
        .chat-bubble-bot { background-color: #E5E7EB; color: #1F2937; }
        /* Simple typing indicator */
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #9CA3AF;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl bg-white rounded-lg shadow-xl flex flex-col h-[85vh]">
        <!-- Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg flex justify-between items-center">
            <h1 class="text-xl font-semibold">LoanBot Assistant</h1>
            <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded focus:outline-none focus:shadow-outline">
                (Reset)
            </button>
        </div>

        <!-- Customer ID Input -->
        <div class="p-3 border-b border-gray-200 bg-gray-50 flex items-center space-x-2">
            <label for="customerId" class="text-sm font-medium text-gray-700">Customer ID:</label>
            <input type="text" id="customerId" value="101" class="text-sm border border-gray-300 rounded px-2 py-1 w-24 focus:outline-none focus:ring-1 focus:ring-blue-500">
        </div>

        <!-- Chat Area -->
        <div id="chatArea" class="flex-1 p-4 overflow-y-auto space-y-4">
            <!-- Messages will be appended here -->
             <div class="flex justify-start">
                <div class="chat-bubble chat-bubble-bot p-3 rounded-lg">
                    <p class="text-sm">Hi! I’m your personal loan assistant. You can ask to 'apply for a loan' to get started.</p>
                </div>
            </div>
        </div>

         <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-4 pb-2 hidden">
             <div class="flex justify-start">
                <div class="chat-bubble chat-bubble-bot p-3 rounded-lg typing-indicator">
                   <span></span><span></span><span></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
            <div class="flex items-center space-x-2">
                <input type="text" id="messageInput" class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message...">

                <!-- File Input (Hidden) -->
                <input type="file" id="fileUpload" accept=".pdf,.jpg,.jpeg,.png" class="hidden">

                <!-- Upload Button (Shows conditionally) -->
                <button id="uploadButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline hidden">
                    Upload File
                </button>

                <!-- Send Button (Default) -->
                <button id="sendButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline">
                    Send
                </button>
            </div>
             <p id="uploadStatus" class="text-xs text-center text-gray-500 mt-1 h-4"></p> <!-- For upload feedback -->
        </div>
    </div>

    <script>
        const chatArea = document.getElementById('chatArea');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const resetButton = document.getElementById('resetButton');
        const customerIdInput = document.getElementById('customerId');
        const typingIndicator = document.getElementById('typingIndicator');
        const fileUpload = document.getElementById('fileUpload');
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('uploadStatus');

        // --- NEW: State Variable ---
        let expectingFileUpload = false;
        let currentLoanId = null; // Store loan ID if possible (for upload)

        // --- Helper: Add Message to UI ---
        function addMessage(sender, text) {
            const bubble = document.createElement('div');
            bubble.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start');

            const content = document.createElement('div');
            content.classList.add('chat-bubble', sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot', 'p-3', 'rounded-lg');

            const p = document.createElement('p');
            p.classList.add('text-sm');
            p.textContent = text; // Use textContent for security

            content.appendChild(p);
            bubble.appendChild(content);
            chatArea.appendChild(bubble);
            chatArea.scrollTop = chatArea.scrollHeight; // Scroll to bottom
        }

        // --- Helper: Toggle Input Mode ---
        function toggleInputMode(isFile) {
            expectingFileUpload = isFile;
            if (isFile) {
                messageInput.classList.add('hidden');
                sendButton.classList.add('hidden');
                uploadButton.classList.remove('hidden');
                uploadStatus.textContent = 'Please upload your document.';
            } else {
                messageInput.classList.remove('hidden');
                sendButton.classList.remove('hidden');
                uploadButton.classList.add('hidden');
                uploadStatus.textContent = ''; // Clear status
                messageInput.focus();
            }
        }

        // --- Handle Sending Message ---
        async function sendMessage() {
            const messageText = messageInput.value.trim();
            const customerId = customerIdInput.value.trim();

            if (!messageText || !customerId) {
                alert('Please enter a Customer ID and a message.');
                return;
            }

            addMessage('user', messageText);
            messageInput.value = ''; // Clear input
            typingIndicator.classList.remove('hidden'); // Show typing
            sendButton.disabled = true;
            messageInput.disabled = true;

            try {
                const response = await axios.post('http://127.0.0.1:8000/chat', {
                    customer_id: customerId,
                    message: messageText
                });

                const reply = response.data.reply;
                addMessage('bot', reply);

                // --- NEW: Check if bot asks for upload ---
                if (reply.toLowerCase().includes('upload') && (reply.toLowerCase().includes('salary') || reply.toLowerCase().includes('document'))) {
                    toggleInputMode(true); // Switch to upload mode
                } else {
                    toggleInputMode(false); // Stay/Switch back to text mode
                }

                // --- Attempt to extract loan_id for upload context ---
                 // Very basic extraction - needs refinement based on actual bot messages
                const loanIdMatch = reply.match(/loan id (\d+)/i);
                if (loanIdMatch) {
                    currentLoanId = loanIdMatch[1];
                    console.log("Extracted loanId:", currentLoanId);
                }


            } catch (error) {
                console.error('Error sending message:', error);
                let errorMsg = 'Error: Could not connect to the agent. Are all 8 terminals running?';
                 if (error.response && error.response.data && error.response.data.detail) {
                     errorMsg = `Error: ${error.response.status} - ${error.response.data.detail}`;
                 } else if (error.message) {
                    errorMsg = `Error: ${error.message}`;
                 }
                addMessage('bot', errorMsg);
                toggleInputMode(false); // Switch back to text on error
            } finally {
                typingIndicator.classList.add('hidden'); // Hide typing
                // Re-enable based on mode
                if (!expectingFileUpload) {
                     sendButton.disabled = false;
                     messageInput.disabled = false;
                     messageInput.focus();
                } else {
                     uploadButton.disabled = false; // Enable upload button
                }
            }
        }

        // --- NEW: Handle File Upload ---
        async function handleFileUpload() {
            const file = fileUpload.files[0];
            const customerId = customerIdInput.value.trim();

            if (!file) {
                uploadStatus.textContent = 'No file selected.';
                return;
            }
            if (!customerId) {
                 alert('Please ensure Customer ID is entered.');
                 return;
            }

            uploadStatus.textContent = `Uploading ${file.name}...`;
            uploadButton.disabled = true; // Disable while uploading

            const formData = new FormData();
            formData.append('file', file);
            formData.append('customer_id', customerId);
            if (currentLoanId) { // Send loan_id if we have it
                 formData.append('loan_id', currentLoanId);
            }
            // Determine doc_type (simple check for now)
            const docType = (file.type.includes('pdf') || file.type.includes('image')) && (file.name.toLowerCase().includes('salary') || file.name.toLowerCase().includes('slip')) ? 'salary_slip' : 'other';
            formData.append('doc_type', docType);


            try {
                const response = await axios.post('http://127.0.0.1:8000/upload', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                const filePath = response.data.file_path;
                uploadStatus.textContent = `Upload successful: ${file.name}`;
                addMessage('user', `(Uploaded ${docType}: ${file.name})`); // Add upload confirmation to chat

                // --- Send file path back to Master Agent ---
                // We send a specific message format that the Master Agent can parse
                // (This requires the Master Agent /chat endpoint to handle this format)
                const pathMessage = `uploaded_file::${filePath}`;

                typingIndicator.classList.remove('hidden'); // Show typing

                const chatResponse = await axios.post('http://127.0.0.1:8000/chat', {
                    customer_id: customerId,
                    message: pathMessage
                });

                const reply = chatResponse.data.reply;
                addMessage('bot', reply);

                // Check if bot needs another upload or switches back to text
                 if (reply.toLowerCase().includes('upload') && (reply.toLowerCase().includes('salary') || reply.toLowerCase().includes('document'))) {
                    toggleInputMode(true); // Stay in upload mode
                } else {
                    toggleInputMode(false); // Switch back to text mode
                }


            } catch (error) {
                 console.error('Error uploading file or sending path:', error);
                 let errorMsg = 'Error during upload or processing.';
                  if (error.response && error.response.data && error.response.data.detail) {
                     errorMsg = `Upload Error: ${error.response.status} - ${error.response.data.detail}`;
                 } else if (error.message) {
                    errorMsg = `Upload Error: ${error.message}`;
                 }
                 uploadStatus.textContent = errorMsg;
                 addMessage('bot', errorMsg); // Add error to chat
                 toggleInputMode(false); // Switch back to text on error
            } finally {
                 typingIndicator.classList.add('hidden'); // Hide typing
                 fileUpload.value = ''; // Reset file input
                 // Re-enable based on mode
                 if (!expectingFileUpload) {
                     sendButton.disabled = false;
                     messageInput.disabled = false;
                     messageInput.focus();
                 } else {
                     uploadButton.disabled = false; // Re-enable upload button
                 }
            }
        }


        // --- Event Listeners ---
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        resetButton.addEventListener('click', async () => {
             const customerId = customerIdInput.value.trim();
             if (!customerId) {
                  alert('Please enter a Customer ID to reset.');
                  return;
             }
             try {
                 // Call the backend reset endpoint
                 await axios.get(`http://127.0.0.1:8000/reset/${customerId}`);
                 // Clear UI
                 chatArea.innerHTML = `
                     <div class="flex justify-start">
                        <div class="chat-bubble chat-bubble-bot p-3 rounded-lg">
                            <p class="text-sm">Hi! I’m your personal loan assistant. You can ask to 'apply for a loan' to get started.</p>
                        </div>
                    </div>`;
                 toggleInputMode(false); // Ensure back to text mode
                 currentLoanId = null; // Reset loan ID
                 messageInput.value = '';
                 console.log(`Conversation reset for ${customerId}`);
             } catch (error) {
                 console.error('Error resetting conversation:', error);
                 alert(`Failed to reset conversation: ${error.message}`);
             }

        });

        // --- NEW: File Input Listeners ---
        uploadButton.addEventListener('click', () => {
            fileUpload.click(); // Trigger hidden file input
        });

        fileUpload.addEventListener('change', handleFileUpload); // Handle file selection

    </script>
</body>
</html>

